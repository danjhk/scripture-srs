<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scripture SRS</title>
    <!-- Tailwind (for the classes you already use) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM + Babel (lets us run your JSX in-browser) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- OPTIONAL: Supabase (only used in Phase 2). Safe to leave here. -->
    <script defer src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

    <!-- Put your Supabase keys here later (Phase 2). For now, leave empty. -->
    <script>
      window.SUPABASE_URL = "https://wfqbfapvwrulfzblskws.supabase.co";   // e.g., "https://xxxx.supabase.co"
      window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmcWJmYXB2d3J1bGZ6Ymxza3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTkxMTUsImV4cCI6MjA3NDAzNTExNX0.lzLU2X3sY6seixhUyJqQu4jaw84CmtQnsLl328fPB9o";  // e.g., "eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp..."
    </script>

    <style>
      body { background: #f8fafc; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Your app code -->
    <script type="text/babel" data-type="module" src="./app.jsx"></script>
    <script type="text/babel">
        // Only runs if keys are set
        (function(){
          if (!window.SUPABASE_URL || !window.SUPABASE_ANON || !window.supabase) return;
      
          const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
      
          // Simple auth button in the top-right (no React needed)
          const bar = document.createElement('div');
          bar.style.position='fixed'; bar.style.top='8px'; bar.style.right='8px'; bar.style.zIndex='1000';
          bar.innerHTML = `
            <button id="srs-signin" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">Sign in</button>
            <button id="srs-signout" class="px-3 py-2 rounded-xl bg-gray-200" style="display:none">Sign out</button>
          `;
          document.body.appendChild(bar);
      
          async function refreshButtons() {
            const { data } = await client.auth.getUser();
            const signedIn = !!data.user;
            document.getElementById('srs-signin').style.display = signedIn ? 'none' : '';
            document.getElementById('srs-signout').style.display = signedIn ? '' : 'none';
            if (signedIn) { pullAll(); }
          }
      
          document.getElementById('srs-signin').onclick = async () => {
            // easiest: magic link (change email as desired)
            const email = prompt("Enter your email for a sign-in link:");
            if (!email) return;
            const { error } = await client.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href }});
            if (error) alert(error.message); else alert("Check your email for the login link.");
          };
          document.getElementById('srs-signout').onclick = async () => { await client.auth.signOut(); refreshButtons(); };
      
          client.auth.onAuthStateChange(() => refreshButtons());
          refreshButtons();
      
          // Helpers to read/write your app's state
          function getState() {
            try { return JSON.parse(localStorage.getItem("scripture_srs_v1")) || { cards:[], settings:{} }; }
            catch { return { cards:[], settings:{} }; }
          }
          function setCardsLocal(cards) {
            const st = getState(); st.cards = cards;
            localStorage.setItem("scripture_srs_v1", JSON.stringify(st));
            // Force a soft reload so React state picks up changes (simplest)
            location.reload();
          }
          function setSettingsLocal(settings) {
            const st = getState(); st.settings = settings;
            localStorage.setItem("scripture_srs_v1", JSON.stringify(st));
          }
      
          // Pull from cloud and LWW-merge into local
          async function pullAll() {
            const { data: user } = await client.auth.getUser();
            if (!user?.user) return;
            const uid = user.user.id;
      
            const { data: rows } = await client.from('cards').select('*').eq('user_id', uid);
            const pulledCards = (rows||[]).map(r => ({
              id: r.id, ref: r.ref, text: r.text, pack: r.pack,
              contentHash: r.content_hash, box: r.box, nextDue: r.next_due,
              createdAt: new Date(r.created_at).getTime(), updatedAt: new Date(r.updated_at).getTime(),
              deletedAt: r.deleted_at ? new Date(r.deleted_at).getTime() : null,
            }));
            // Merge with local
            const local = getState().cards || [];
            const map = new Map(local.map(c => [c.id, c]));
            for (const r of pulledCards) {
              const l = map.get(r.id);
              if (!l || r.updatedAt > (l.updatedAt || 0)) map.set(r.id, r);
            }
            setCardsLocal(Array.from(map.values()).filter(c => !c.deletedAt));
      
            // Settings
            const { data: s } = await client.from('settings').select('*').eq('user_id', uid).maybeSingle();
            if (s) {
              setSettingsLocal({
                sessionTarget: s.session_target, mode: s.mode,
                showFirstNWords: s.show_first_n_words, shuffle: s.shuffle,
              });
            }
          }
      
          // Push local to cloud whenever you click this (manual/safe)
          window.pushSRS = async function pushAll() {
            const { data: user } = await client.auth.getUser();
            if (!user?.user) { alert("Sign in first."); return; }
            const uid = user.user.id;
      
            const { cards, settings } = getState();
            if (cards?.length) {
              const rows = cards.map(c => ({
                id: c.id || crypto.randomUUID(),
                user_id: uid,
                ref: c.ref, text: c.text, pack: c.pack,
                content_hash: (c.contentHash || (c.ref && c.text ? (function(s){ let h=2166136261>>>0; for (let i=0;i<s.length;i++) { h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return (h>>>0).toString(36);} )(`${c.ref}|${c.text}`) : "")),
                box: c.box||1, next_due: c.nextDue||0,
                created_at: new Date(c.createdAt||Date.now()).toISOString(),
                updated_at: new Date(c.updatedAt||Date.now()).toISOString(),
                deleted_at: c.deletedAt ? new Date(c.deletedAt).toISOString() : null,
              }));
              await client.from('cards').upsert(rows, { onConflict: 'id' });
            }
      
            await client.from('settings').upsert({
              user_id: uid,
              session_target: settings?.sessionTarget ?? 50,
              mode: settings?.mode ?? 'recognition',
              show_first_n_words: settings?.showFirstNWords ?? 6,
              shuffle: settings?.shuffle ?? true,
              updated_at: new Date().toISOString(),
            });
      
            alert("Pushed local data to cloud. Open on your iPad/iPhone → sign in → it’ll pull.");
          };
      
          // Add a floating push button (optional)
          const pushBtn = document.createElement('button');
          pushBtn.textContent = 'Push to Cloud';
          pushBtn.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-xl bg-emerald-600 text-white shadow';
          pushBtn.onclick = () => window.pushSRS();
          document.body.appendChild(pushBtn);
        })();
      </script>
  </body>
</html>
<!-- bump -->