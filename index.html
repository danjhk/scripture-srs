<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scripture SRS</title>
    <!-- Tailwind (for the classes you already use) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM + Babel (lets us run your JSX in-browser) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase UMD -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <!-- Put your Supabase keys here later (Phase 2). For now, leave empty. -->
    <script>
      window.SUPABASE_URL = "https://wfqbfapvwrulfzblskws.supabase.co";   // e.g., "https://xxxx.supabase.co"
      window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmcWJmYXB2d3J1bGZ6Ymxza3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTkxMTUsImV4cCI6MjA3NDAzNTExNX0.lzLU2X3sY6seixhUyJqQu4jaw84CmtQnsLl328fPB9o";  // e.g., "eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp..."
    </script>

    <style>
      body { background: #f8fafc; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Your app code -->
    <script type="text/babel" data-type="module" src="./app.jsx"></script>
    <script>
    (function initAuthBar() {
      // Render the bar immediately so something is visible
      const bar = document.createElement('div');
      bar.style.position='fixed'; bar.style.top='8px'; bar.style.right='8px'; bar.style.zIndex='100000';
      bar.innerHTML = `
        <button id="srs-signin" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">Sign in</button>
        <button id="srs-signout" class="px-3 py-2 rounded-xl bg-gray-200" style="display:none">Sign out</button>
      `;
      document.body.appendChild(bar);

      const signinBtn  = document.getElementById('srs-signin');
      const signoutBtn = document.getElementById('srs-signout');

      // Disable until Supabase is loaded
      signinBtn.disabled = true;
      signinBtn.textContent = 'Loading...';

      function ready(cb) {
        if (window.supabase) return cb();
        // also listen for the <script> load event as a backup
        const s = document.querySelector('script[src*="supabase-js"]');
        if (s) s.addEventListener('load', () => cb(), { once: true });
        // and poll in case it was cached
        const t = setInterval(() => {
          if (window.supabase) { clearInterval(t); cb(); }
        }, 50);
      }

      function start() {
        const client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON);

        async function refreshButtons() {
          const { data } = await client.auth.getUser();
          const signedIn = !!data.user;
          signinBtn.style.display  = signedIn ? 'none' : '';
          signoutBtn.style.display = signedIn ? '' : 'none';
          if (signedIn) { pullAll(); }
        }

        signinBtn.disabled = false;
        signinBtn.textContent = 'Sign in';

        signinBtn.onclick = async () => {
          const email = prompt("Enter your email for a sign-in link:");
          if (!email) return;
          const { error } = await client.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: location.href }
          });
          if (error) alert(error.message);
          else alert("Check your email and click the sign-in link.");
        };

        signoutBtn.onclick = async () => {
          await client.auth.signOut();
          refreshButtons();
        };

        client.auth.onAuthStateChange(() => refreshButtons());
        refreshButtons();

        // ---- your existing helpers (unchanged) ----
        function getState() {
          try { return JSON.parse(localStorage.getItem("scripture_srs_v1")) || { cards:[], settings:{} }; }
          catch { return { cards:[], settings:{} }; }
        }
        function setCardsLocal(cards) {
          const st = getState(); st.cards = cards;
          localStorage.setItem("scripture_srs_v1", JSON.stringify(st));
          location.reload();
        }
        function setSettingsLocal(settings) {
          const st = getState(); st.settings = settings;
          localStorage.setItem("scripture_srs_v1", JSON.stringify(st));
        }

        async function pullAll() {
          const { data: user } = await client.auth.getUser();
          if (!user?.user) return;
          const uid = user.user.id;

          const { data: rows } = await client.from('cards').select('*').eq('user_id', uid);
          const pulledCards = (rows||[]).map(r => ({
            id: r.id, ref: r.ref, text: r.text, pack: r.pack,
            contentHash: r.content_hash, box: r.box, nextDue: r.next_due,
            createdAt: new Date(r.created_at).getTime(), updatedAt: new Date(r.updated_at).getTime(),
            deletedAt: r.deleted_at ? new Date(r.deleted_at).getTime() : null,
          }));
          const local = getState().cards || [];
          const map = new Map(local.map(c => [c.id, c]));
          for (const r of pulledCards) {
            const l = map.get(r.id);
            if (!l || r.updatedAt > (l.updatedAt || 0)) map.set(r.id, r);
          }
          setCardsLocal(Array.from(map.values()).filter(c => !c.deletedAt));

          const { data: s } = await client.from('settings').select('*').eq('user_id', uid).maybeSingle();
          if (s) setSettingsLocal({
            sessionTarget: s.session_target, mode: s.mode,
            showFirstNWords: s.show_first_n_words, shuffle: s.shuffle,
          });
        }

        window.pushSRS = async function pushAll() {
          const { data: user } = await client.auth.getUser();
          if (!user?.user) { alert("Sign in first."); return; }
          const uid = user.user.id;

          const { cards, settings } = getState();
          if (cards?.length) {
            const rows = cards.map(c => ({
              id: c.id || crypto.randomUUID(),
              user_id: uid,
              ref: c.ref, text: c.text, pack: c.pack,
              content_hash: (c.contentHash || (function(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)}return (h>>>0).toString(36)})(`${c.ref}|${c.text}`)),
              box: c.box||1, next_due: c.nextDue||0,
              created_at: new Date(c.createdAt||Date.now()).toISOString(),
              updated_at: new Date(c.updatedAt||Date.now()).toISOString(),
              deleted_at: c.deletedAt ? new Date(c.deletedAt).toISOString() : null,
            }));
            await client.from('cards').upsert(rows, { onConflict: 'id' });
          }
          await client.from('settings').upsert({
            user_id: uid,
            session_target: settings?.sessionTarget ?? 50,
            mode: settings?.mode ?? 'recognition',
            show_first_n_words: settings?.showFirstNWords ?? 6,
            shuffle: settings?.shuffle ?? true,
            updated_at: new Date().toISOString(),
          });
          alert("Pushed local data to cloud.");
        };

        const pushBtn = document.createElement('button');
        pushBtn.textContent = 'Push to Cloud';
        pushBtn.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-xl bg-emerald-600 text-white shadow';
        pushBtn.onclick = () => window.pushSRS();
        document.body.appendChild(pushBtn);
      }

      function boot() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => ready(start));
        } else {
          ready(start);
        }
      }
      boot();
    })();
    </script>
   
  </body>
</html>
<!-- bump -->